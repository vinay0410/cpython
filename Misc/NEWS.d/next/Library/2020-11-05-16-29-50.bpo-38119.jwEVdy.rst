Fix shared_memory's resource tracking by using reference counting
